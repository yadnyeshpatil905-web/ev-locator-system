<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>GRIDFLOW - Smart EV Charging</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
/* ================= THEME ================= */
:root{
  --bg:#0b0b0b;
  --panel:#121212;
  --yellow:#facc15;
  --green:#10b981;
  --red:#ef4444;
  --blue:#3b82f6;
  --purple:#8b5cf6;
  --text:#f5f5f5;
  --muted:#9ca3af;
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
  background:var(--bg);
  color:var(--text);
  overflow:hidden;
}

/* ================= LOGIN/REGISTER PAGE ================= */
.auth-page {
  height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 2rem;
  background: linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 100%);
}

.auth-container {
  background: var(--panel);
  border-radius: 24px;
  padding: 3rem;
  width: 100%;
  max-width: 500px;
  border: 1px solid #333;
  box-shadow: 0 20px 50px rgba(0,0,0,0.5);
  animation: slideUp .6s ease;
}

@keyframes slideUp {
  from { transform: translateY(30px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.auth-header {
  text-align: center;
  margin-bottom: 2.5rem;
}

.auth-header h1 {
  color: var(--yellow);
  font-size: 2.5rem;
  margin-bottom: 0.5rem;
  letter-spacing: 1px;
}

.auth-header .logo {
  font-size: 2.5rem;
  font-weight: 700;
  letter-spacing: 2px;
  color: white;
}
.auth-header .logo span {
  color: var(--yellow);
}

.auth-header p {
  color: var(--muted);
  font-size: 1rem;
  margin-top: 0.5rem;
}

.auth-tabs {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 2rem;
  background: rgba(0,0,0,0.3);
  padding: 0.3rem;
  border-radius: 12px;
}

.auth-tab {
  flex: 1;
  padding: 1rem;
  background: transparent;
  border: none;
  border-radius: 10px;
  color: var(--muted);
  font-weight: 600;
  cursor: pointer;
  transition: .3s;
  text-align: center;
  font-size: 1rem;
}

.auth-tab.active {
  background: var(--yellow);
  color: black;
}

.auth-tab:hover:not(.active) {
  background: rgba(255,255,255,0.05);
  color: var(--text);
}

.auth-form {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: 0.8rem;
}

.form-group label {
  font-size: 0.9rem;
  color: var(--muted);
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.form-group input {
  padding: 1rem 1.2rem;
  background: rgba(0,0,0,0.5);
  border: 1px solid #333;
  border-radius: 12px;
  color: white;
  font-size: 1rem;
  transition: .3s;
}

.form-group input:focus {
  outline: none;
  border-color: var(--yellow);
  box-shadow: 0 0 0 3px rgba(250, 204, 21, 0.1);
}

.auth-btn {
  padding: 1rem;
  background: var(--yellow);
  color: black;
  border: none;
  border-radius: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: .3s;
  font-size: 1rem;
  margin-top: 0.5rem;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.8rem;
}

.auth-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 20px rgba(250, 204, 21, 0.2);
}

.auth-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none !important;
}

.auth-error {
  background: rgba(239, 68, 68, 0.1);
  border: 1px solid var(--red);
  color: var(--red);
  padding: 1rem;
  border-radius: 10px;
  font-size: 0.9rem;
  margin-top: 1rem;
  display: none;
  align-items: center;
  gap: 0.8rem;
  animation: shake 0.5s;
}

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-5px); }
  75% { transform: translateX(5px); }
}

.auth-success {
  background: rgba(16, 185, 129, 0.1);
  border: 1px solid var(--green);
  color: var(--green);
  padding: 1rem;
  border-radius: 10px;
  font-size: 0.9rem;
  margin-top: 1rem;
  display: none;
  align-items: center;
  gap: 0.8rem;
}

.auth-footer {
  text-align: center;
  margin-top: 2rem;
  padding-top: 2rem;
  border-top: 1px solid #333;
  color: var(--muted);
  font-size: 0.9rem;
}

.auth-footer a {
  color: var(--yellow);
  text-decoration: none;
  font-weight: 600;
  cursor: pointer;
}

.auth-footer a:hover {
  text-decoration: underline;
}

.password-strength {
  margin-top: 0.5rem;
  font-size: 0.8rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.password-strength.weak { color: var(--red); }
.password-strength.medium { color: #f59e0b; }
.password-strength.strong { color: var(--green); }

/* ================= MAIN APP (Hidden initially) ================= */
.main-app {
  display: none;
  height: 100vh;
  overflow: hidden;
}

/* ================= LANDING ================= */
.landing{
  height:100vh;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  gap:1.5rem;
  animation:fadeIn 1s ease;
  padding: 1rem;
  position: relative;
  z-index: 1;
}

@keyframes fadeIn{
  from{opacity:0;transform:translateY(20px)}
  to{opacity:1;transform:translateY(0)}
}

.logo{
  font-size:3rem;
  font-weight:700;
  letter-spacing:2px;
  text-align: center;
}
.logo span{color:var(--yellow)}

.tagline{
  color:var(--muted);
  font-size:1rem;
  text-align: center;
  max-width: 600px;
}

.cta{
  padding:1rem 2.5rem;
  background:var(--yellow);
  color:black;
  border:none;
  border-radius:999px;
  font-weight:600;
  cursor:pointer;
  transition:.3s;
  font-size: 1rem;
}
.cta:hover{
  transform:scale(1.05);
  box-shadow: 0 0 20px rgba(250, 204, 21, 0.3);
}

.cta-secondary {
  padding:1rem 2.5rem;
  background:transparent;
  color:var(--yellow);
  border:1px solid var(--yellow);
  border-radius:999px;
  font-weight:600;
  cursor:pointer;
  transition:.3s;
  font-size: 1rem;
}
.cta-secondary:hover{
  background:rgba(250, 204, 21, 0.1);
}

/* ================= CONFIG PANEL ================= */
.config{
  position:fixed;
  inset:0;
  background:var(--bg);
  padding:3rem;
  display:none;
  animation:slideUp .6s ease;
  z-index: 100;
  overflow-y: auto;
}

.config h2{
  font-size:2rem;
  margin-bottom:1rem;
  color: var(--yellow);
}

.cards{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:1.5rem;
  margin-top:2rem;
}

.card{
  background:var(--panel);
  border-radius:18px;
  padding:1.5rem;
  border:1px solid #1f1f1f;
  transition:.3s;
}
.card:hover{
  border-color:var(--yellow);
  transform:translateY(-4px);
  box-shadow: 0 10px 20px rgba(0,0,0,0.2);
}

.card label{
  font-size:.8rem;
  color:var(--muted);
  display: block;
  margin-bottom: 0.5rem;
}

select{
  width:100%;
  margin-top:.6rem;
  padding:.8rem;
  background:black;
  border:1px solid #333;
  color:white;
  border-radius:10px;
  font-size: 1rem;
}

/* ================= MAP VIEW ================= */
.map-view{
  position:fixed;
  inset:0;
  display:none;
  background:black;
  z-index: 50;
}

#map{
  height:100%;
  animation:mapReveal 1s ease;
}

@keyframes mapReveal{
  from{opacity:0;transform:scale(1.05)}
  to{opacity:1;transform:scale(1)}
}

/* ================= TOP BAR ================= */
.topbar{
  position:absolute;
  top:20px;
  left:50%;
  transform:translateX(-50%);
  background:rgba(0,0,0,.85);
  backdrop-filter: blur(10px);
  padding:.8rem 1.5rem;
  border-radius:999px;
  border:1px solid #333;
  display:flex;
  gap:1rem;
  align-items:center;
  z-index: 1000;
  flex-wrap: wrap;
  justify-content: center;
  max-width: 90%;
}
.topbar span{
  color:var(--yellow);
  font-weight:600;
}

.topbar button {
  background: var(--yellow);
  color: black;
  border: none;
  border-radius: 999px;
  padding: 0.5rem 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: .3s;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}
.topbar button:hover {
  opacity: 0.9;
  transform: translateY(-2px);
}

.topbar button.secondary {
  background: transparent;
  color: var(--yellow);
  border: 1px solid var(--yellow);
}

.user-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: var(--yellow);
  color: black;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  cursor: pointer;
  border: 2px solid transparent;
  transition: .3s;
}

.user-avatar:hover {
  border-color: white;
  transform: scale(1.1);
}

.user-menu {
  position: absolute;
  top: 70px;
  right: 20px;
  background: var(--panel);
  border: 1px solid #333;
  border-radius: 12px;
  padding: 1rem;
  min-width: 200px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.5);
  z-index: 1001;
  display: none;
  animation: fadeIn .3s ease;
}

.user-menu.active {
  display: block;
}

.user-menu p {
  margin: 0.5rem 0;
  padding: 0.5rem;
  color: var(--muted);
  border-bottom: 1px solid #333;
}

.user-menu button {
  width: 100%;
  padding: 0.8rem;
  background: transparent;
  border: 1px solid #333;
  color: var(--text);
  border-radius: 8px;
  cursor: pointer;
  transition: .3s;
  margin-top: 0.5rem;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
}

.user-menu button:hover {
  background: rgba(255,255,255,0.05);
  border-color: var(--yellow);
  color: var(--yellow);
}

/* Update topbar to include user avatar */
.topbar .user-section {
  display: flex;
  align-items: center;
  gap: 1rem;
}
 
 /* ===== ELECTRIC ENERGY BACKGROUND ===== */
.energy-bg{
  position:absolute;
  inset:0;
  overflow:hidden;
  z-index:-1;
}

.features{
  margin-top:3rem;
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:1.5rem;
  width:80%;
  max-width:1100px;
}

.feature-card{
  background:rgba(20,20,20,.8);
  border:1px solid #1f1f1f;
  padding:1.5rem;
  border-radius:18px;
  text-align:left;
  transition:.3s;
  backdrop-filter: blur(10px);
}

.feature-card strong{
  display:block;
  color:var(--yellow);
  margin-bottom:.4rem;
}

.feature-card p{
  color:var(--muted);
  font-size:.85rem;
}

.feature-card:hover{
  transform:translateY(-6px);
  border-color:var(--yellow);
  box-shadow: 0 10px 20px rgba(0,0,0,0.3);
}

.energy-bg span{
  position:absolute;
  width:2px;
  height:120px;
  background:linear-gradient(
    transparent,
    rgba(250,204,21,.8),
    transparent
  );
  animation:boltMove linear infinite;
  opacity:.7;
}

@keyframes boltMove{
  from{transform:translateY(-120px)}
  to{transform:translateY(110vh)}
}
  
   /* ================= HOW IT WORKS ================= */
.howitworks{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.97);
  padding:3rem;
  z-index:999;
  animation:fadeIn .4s ease;
  overflow-y: auto;
}

.howitworks.hidden{
  display:none;
}

.how-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:2rem;
}

.how-header h2{
  font-size:2rem;
  color:var(--yellow);
}

.how-header button{
  background:none;
  border:none;
  color:var(--muted);
  font-size:1.4rem;
  cursor:pointer;
}

.how-content{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
  gap:1.8rem;
}

.how-card{
  background:#121212;
  border:1px solid #1f1f1f;
  padding:1.8rem;
  border-radius:20px;
  transition:.3s;
}

.how-card span{
  font-size:.9rem;
  color:var(--yellow);
  font-weight:600;
}

.how-card h3{
  margin:.6rem 0;
}

.how-card p{
  font-size:.9rem;
  color:var(--muted);
  line-height:1.5;
}

.how-card:hover{
  transform:translateY(-6px);
  border-color:var(--yellow);
}

.how-card.highlight{
  background:linear-gradient(135deg,#1a1a1a,#0f0f0f);
  border-color:var(--yellow);
}

/* ================= STATION DETAILS PANEL ================= */
.station-details {
  position: fixed;
  right: 0;
  top: 0;
  width: 420px;
  height: 100vh;
  background: var(--panel);
  border-left: 1px solid #333;
  padding: 2rem;
  transform: translateX(100%);
  transition: transform 0.4s ease;
  z-index: 1000;
  overflow-y: auto;
  box-shadow: -10px 0 30px rgba(0,0,0,0.3);
}

.station-details.active {
  transform: translateX(0);
}

.station-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.5rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid #333;
}

.station-header h3 {
  margin: 0;
  font-size: 1.5rem;
  color: var(--yellow);
}

.close-details {
  background: none;
  border: none;
  color: var(--muted);
  font-size: 1.4rem;
  cursor: pointer;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: .3s;
}
.close-details:hover {
  background: rgba(255,255,255,0.1);
}

.station-info {
  margin-bottom: 1.5rem;
  background: rgba(0,0,0,0.3);
  padding: 1.5rem;
  border-radius: 12px;
}

.station-info p {
  display: flex;
  align-items: center;
  gap: 0.8rem;
  margin: 0.8rem 0;
  padding: 0.5rem 0;
  border-bottom: 1px solid rgba(255,255,255,0.05);
}

.station-info p:last-child {
  border-bottom: none;
}

.station-info i {
  color: var(--yellow);
  width: 20px;
  text-align: center;
}

.availability {
  margin: 2rem 0;
  padding: 1.5rem;
  background: rgba(0,0,0,0.3);
  border-radius: 12px;
}

.availability h4 {
  margin-top: 0;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.availability-status {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.4rem 1rem;
  border-radius: 999px;
  font-size: 0.9rem;
  font-weight: 600;
}

.available {
  background: rgba(16, 185, 129, 0.2);
  color: var(--green);
  border: 1px solid var(--green);
}

.limited {
  background: rgba(245, 158, 11, 0.2);
  color: #f59e0b;
  border: 1px solid #f59e0b;
}

.busy {
  background: rgba(239, 68, 68, 0.2);
  color: var(--red);
  border: 1px solid var(--red);
}

.slots-container {
  margin: 1.5rem 0;
}

.slots-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
}

.slots {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 0.8rem;
  margin: 1rem 0;
}

.slot {
  background: rgba(255,255,255,0.05);
  border: 1px solid #333;
  border-radius: 10px;
  padding: 1rem 0.5rem;
  text-align: center;
  cursor: pointer;
  transition: .3s;
  display: flex;
  flex-direction: column;
  gap: 0.3rem;
}

.slot:hover {
  border-color: var(--yellow);
  transform: translateY(-3px);
  background: rgba(250, 204, 21, 0.05);
}

.slot.booked {
  background: rgba(239, 68, 68, 0.1);
  border-color: var(--red);
  opacity: 0.6;
  cursor: not-allowed;
}

.slot.selected {
  background: rgba(250, 204, 21, 0.15);
  border-color: var(--yellow);
  box-shadow: 0 0 15px rgba(250, 204, 21, 0.2);
}

.slot-time {
  font-weight: 600;
  font-size: 0.9rem;
}

.slot-price {
  font-size: 0.8rem;
  color: var(--green);
  font-weight: 600;
}

.book-btn {
  width: 100%;
  padding: 1rem;
  background: var(--yellow);
  color: black;
  border: none;
  border-radius: 12px;
  font-weight: 600;
  font-size: 1rem;
  cursor: pointer;
  transition: .3s;
  margin-top: 1.5rem;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.8rem;
}

.book-btn:hover {
  opacity: 0.9;
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(250, 204, 21, 0.3);
}

.book-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none !important;
  box-shadow: none !important;
}

.actions-section {
  margin-top: 2rem;
  padding-top: 1.5rem;
  border-top: 1px solid #333;
}

.actions-section h4 {
  margin-bottom: 1rem;
  color: var(--yellow);
}

.action-btn {
  width: 100%;
  padding: 0.9rem;
  border-radius: 10px;
  font-weight: 600;
  cursor: pointer;
  transition: .3s;
  margin-bottom: 0.8rem;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.8rem;
  border: 1px solid transparent;
}

.action-btn.primary {
  background: var(--blue);
  color: white;
}

.action-btn.secondary {
  background: transparent;
  color: var(--muted);
  border: 1px solid var(--muted);
}

.action-btn:hover {
  transform: translateY(-2px);
}

/* ================= LOCATION MARKERS ================= */
.leaflet-marker-icon {
  filter: drop-shadow(0 0 6px rgba(0,0,0,0.7));
}

.user-location-marker {
  background: var(--blue);
  border-radius: 50%;
  width: 20px !important;
  height: 20px !important;
  border: 3px solid white;
  box-shadow: 0 0 15px var(--blue);
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
  70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
  100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
}

/* ================= NAVIGATION PANEL ================= */
.navigation-panel {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.9);
  backdrop-filter: blur(10px);
  border: 1px solid #333;
  border-radius: 18px;
  padding: 1.5rem;
  width: 90%;
  max-width: 500px;
  z-index: 1000;
  display: none;
  box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}

.navigation-panel.active {
  display: block;
  animation: slideUp .4s ease;
}

.nav-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid #333;
}

.nav-info h4 {
  margin: 0;
  color: var(--yellow);
}

.nav-info p {
  margin: 0.3rem 0 0;
  font-size: 0.9rem;
  color: var(--muted);
}

.nav-stats {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 1rem;
  margin: 1.5rem 0;
}

.stat {
  text-align: center;
  padding: 1rem 0.8rem;
  background: rgba(255,255,255,0.05);
  border-radius: 12px;
  transition: .3s;
}

.stat:hover {
  background: rgba(255,255,255,0.08);
  transform: translateY(-3px);
}

.stat-value {
  font-size: 1.3rem;
  font-weight: 600;
  color: var(--yellow);
}

.stat-label {
  font-size: 0.8rem;
  color: var(--muted);
  margin-top: 0.3rem;
}

.nav-actions {
  display: flex;
  gap: 1rem;
}

.nav-btn {
  flex: 1;
  padding: 1rem;
  border: none;
  border-radius: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: .3s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
}

.nav-btn.primary {
  background: var(--yellow);
  color: black;
}

.nav-btn.secondary {
  background: transparent;
  color: var(--yellow);
  border: 1px solid var(--yellow);
}

.nav-btn:hover {
  transform: translateY(-2px);
}

/* ================= MY BOOKINGS ================= */
.my-bookings {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.95);
  padding: 3rem;
  z-index: 999;
  animation: fadeIn .4s ease;
  overflow-y: auto;
  display: none;
}

.my-bookings.active {
  display: block;
}

.bookings-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 2rem;
}

.bookings-header h2 {
  font-size: 2rem;
  color: var(--yellow);
}

.bookings-header button {
  background: none;
  border: none;
  color: var(--muted);
  font-size: 1.4rem;
  cursor: pointer;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: .3s;
}
.bookings-header button:hover {
  background: rgba(255,255,255,0.1);
}

.bookings-list {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 1.5rem;
  margin-top: 2rem;
}

.booking-card {
  background: #121212;
  border: 1px solid #333;
  border-radius: 15px;
  padding: 1.5rem;
  transition: .3s;
}

.booking-card:hover {
  transform: translateY(-5px);
  border-color: var(--yellow);
  box-shadow: 0 10px 20px rgba(0,0,0,0.3);
}

.booking-card.upcoming {
  border-left: 4px solid var(--green);
}

.booking-card.completed {
  border-left: 4px solid var(--muted);
  opacity: 0.8;
}

.booking-card.cancelled {
  border-left: 4px solid var(--red);
}

.booking-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid #333;
}

.booking-station {
  font-weight: 600;
  font-size: 1.1rem;
  color: var(--yellow);
}

.booking-status {
  padding: 0.3rem 0.8rem;
  border-radius: 999px;
  font-size: 0.8rem;
  font-weight: 600;
}

.status-upcoming {
  background: rgba(16, 185, 129, 0.2);
  color: var(--green);
}

.status-completed {
  background: rgba(156, 163, 175, 0.2);
  color: var(--muted);
}

.status-cancelled {
  background: rgba(239, 68, 68, 0.2);
  color: var(--red);
}

.booking-details p {
  margin: 0.5rem 0;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.booking-details i {
  color: var(--yellow);
  width: 20px;
}

.booking-actions {
  display: flex;
  gap: 0.8rem;
  margin-top: 1rem;
}

.booking-btn {
  flex: 1;
  padding: 0.6rem;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: .3s;
  font-size: 0.9rem;
  border: none;
}

.booking-btn.cancel {
  background: rgba(239, 68, 68, 0.1);
  color: var(--red);
  border: 1px solid var(--red);
}

.booking-btn.navigate {
  background: rgba(59, 130, 246, 0.1);
  color: var(--blue);
  border: 1px solid var(--blue);
}

.booking-btn:hover {
  transform: translateY(-2px);
}

.no-bookings {
  text-align: center;
  padding: 3rem;
  color: var(--muted);
}

.no-bookings i {
  font-size: 3rem;
  margin-bottom: 1rem;
  color: var(--yellow);
}

/* ================= RESPONSIVE ================= */
@media (max-width: 768px) {
  .config, .howitworks, .my-bookings {
    padding: 1.5rem;
  }
  
  .station-details {
    width: 100%;
  }
  
  .topbar {
    flex-direction: column;
    width: 95%;
    padding: 1rem;
  }
  
  .topbar button {
    width: 100%;
    justify-content: center;
  }
  
  .navigation-panel {
    width: 95%;
    bottom: 10px;
    padding: 1rem;
  }
  
  .features {
    width: 95%;
  }
  
  .slots {
    grid-template-columns: repeat(3, 1fr);
  }
  
  .bookings-list {
    grid-template-columns: 1fr;
  }
  
  .auth-container {
    padding: 2rem;
  }
}

@media (max-width: 480px) {
  .slots {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .nav-stats {
    grid-template-columns: 1fr;
  }
  
  .nav-actions {
    flex-direction: column;
  }
  
  .logo {
    font-size: 2.5rem;
  }
  
  .auth-header h1 {
    font-size: 2rem;
  }
}
</style>
</head>

<body>

<!-- AUTHENTICATION PAGE (Shown First) -->
<div class="auth-page" id="authPage">
  <div class="auth-container">
    <div class="auth-header">
      <div class="logo">GRID<span>FLOW</span></div>
      <p>Smart EV Charging Experience • Find, Book & Navigate</p>
    </div>
    
    <div class="auth-tabs">
      <button class="auth-tab active" id="loginTab">Login</button>
      <button class="auth-tab" id="registerTab">Register</button>
    </div>
    
    <!-- Login Form -->
    <form class="auth-form" id="loginForm" onsubmit="handleLogin(event)">
      <div class="form-group">
        <label for="loginEmail"><i class="fas fa-envelope"></i> Email Address</label>
        <input type="email" id="loginEmail" placeholder="you@example.com" required>
      </div>
      
      <div class="form-group">
        <label for="loginPassword"><i class="fas fa-lock"></i> Password</label>
        <input type="password" id="loginPassword" placeholder="••••••••" required>
      </div>
      
      <div class="auth-error" id="loginError">
        <i class="fas fa-exclamation-circle"></i>
        <span id="loginErrorMessage">Invalid credentials</span>
      </div>
      
      <button type="submit" class="auth-btn" id="loginBtn">
        <i class="fas fa-sign-in-alt"></i>
        <span>Sign In</span>
      </button>
    </form>
    
    <!-- Register Form (Hidden Initially) -->
    <form class="auth-form" id="registerForm" onsubmit="handleRegister(event)" style="display: none;">
      <div class="form-group">
        <label for="registerName"><i class="fas fa-user"></i> Full Name</label>
        <input type="text" id="registerName" placeholder="John Doe" required>
      </div>
      
      <div class="form-group">
        <label for="registerEmail"><i class="fas fa-envelope"></i> Email Address</label>
        <input type="email" id="registerEmail" placeholder="you@example.com" required>
      </div>
      
      <div class="form-group">
        <label for="registerPassword"><i class="fas fa-lock"></i> Password</label>
        <input type="password" id="registerPassword" placeholder="••••••••" minlength="6" required oninput="checkPasswordStrength(this.value)">
        <div class="password-strength" id="passwordStrength"></div>
      </div>
      
      <div class="form-group">
        <label for="registerConfirmPassword"><i class="fas fa-lock"></i> Confirm Password</label>
        <input type="password" id="registerConfirmPassword" placeholder="••••••••" minlength="6" required>
      </div>
      
      <div class="auth-error" id="registerError">
        <i class="fas fa-exclamation-circle"></i>
        <span id="registerErrorMessage">Error occurred</span>
      </div>
      
      <div class="auth-success" id="registerSuccess">
        <i class="fas fa-check-circle"></i>
        <span>Registration successful! Redirecting...</span>
      </div>
      
      <button type="submit" class="auth-btn" id="registerBtn">
        <i class="fas fa-user-plus"></i>
        <span>Create Account</span>
      </button>
    </form>
    
    <div class="auth-footer">
      <p id="authFooterText">
        By continuing, you agree to GRIDFLOW's <a href="#">Terms of Service</a> and <a href="#">Privacy Policy</a>
      </p>
    </div>
  </div>
</div>

<!-- MAIN APPLICATION (Hidden Initially) -->
<div class="main-app" id="mainApp">
  
  <!-- USER MENU -->
  <div class="user-menu" id="userMenu">
    <p id="userEmail"></p>
    <p id="userName"></p>
    <button onclick="logout()">
      <i class="fas fa-sign-out-alt"></i> Logout
    </button>
  </div>

  <!-- LANDING -->
  <div class="landing" id="landing">
    <div class="logo">GRID<span>FLOW</span></div>
    <div class="tagline">Smart EV Charging Experience • Find, Book & Navigate to Charging Stations Across India</div>
    
    <div class="features">
      <div class="feature-card">
        <i class="fas fa-bolt"></i> <strong>20+ Stations</strong>
        <p>Locate charging stations across major cities</p>
      </div>
      <div class="feature-card">
        <i class="fas fa-calendar-check"></i> <strong>Easy Booking</strong>
        <p>Reserve slots in advance with real-time availability</p>
      </div>
      <div class="feature-card">
        <i class="fas fa-rupee-sign"></i> <strong>Transparent Pricing</strong>
        <p>All prices in ₹ with no hidden charges</p>
      </div>
      <div class="feature-card">
        <i class="fas fa-route"></i> <strong>Live Navigation</strong>
        <p>Turn-by-turn navigation to your selected station</p>
      </div>
    </div>
    
    <div style="display:flex;gap:1rem;margin-top:1.5rem;flex-wrap: wrap;justify-content: center;">
      <button class="cta" onclick="openConfig()">
        <i class="fas fa-map-marker-alt"></i> Find Stations
      </button>
      <button class="cta-secondary" onclick="openHowItWorks()">
        <i class="fas fa-info-circle"></i> How It Works
      </button>
      <button class="cta-secondary" onclick="openMyBookings()">
        <i class="fas fa-calendar"></i> My Bookings
      </button>
    </div>
  </div>

  <!-- CONFIG -->
  <div class="config" id="config">
    <h2>Configure Your Search</h2>
    <p class="tagline">Select preferences before loading the map</p>

    <div class="cards">
      <div class="card">
        <label><i class="fas fa-plug"></i> Charging Type</label>
        <select id="type">
          <option value="all">All Types</option>
          <option>CCS</option>
          <option>Type-2</option>
          <option>CHAdeMO</option>
          <option>Supercharger</option>
          <option>Bharat AC001</option>
          <option>Bharat DC001</option>
        </select>
      </div>

      <div class="card">
        <label><i class="fas fa-tachometer-alt"></i> Charging Speed</label>
        <select id="speed">
          <option value="all">All Speeds</option>
          <option value="ultra">Ultra Fast (150kW+)</option>
          <option value="fast">Fast (50-150kW)</option>
          <option value="normal">Normal (22kW)</option>
          <option value="slow">Slow (3-7kW)</option>
        </select>
      </div>

      <div class="card">
        <label><i class="fas fa-location-arrow"></i> Range (km)</label>
        <select id="range">
          <option value="50">50 km</option>
          <option value="30">30 km</option>
          <option value="20">20 km</option>
          <option value="10">10 km</option>
          <option value="5">5 km</option>
        </select>
      </div>
      
      <div class="card">
        <label><i class="fas fa-clock"></i> Availability</label>
        <select id="availability">
          <option value="all">All Stations</option>
          <option value="available">Available Now</option>
          <option value="soon">Available Soon</option>
          <option value="24/7">24/7 Open</option>
        </select>
      </div>
    </div>

    <div style="text-align:center;margin-top:3rem;">
      <button class="cta" onclick="openMap()">
        <i class="fas fa-map-marked-alt"></i> Find Charging Stations
      </button>
      <button class="cta-secondary" onclick="goBackToLanding()" style="margin-left:1rem;">
        <i class="fas fa-arrow-left"></i> Back to Home
      </button>
    </div>
  </div>

  <!-- HOW IT WORKS -->
  <div class="howitworks hidden" id="howItWorks">
    <div class="how-header">
      <h2>How GRIDFLOW Works</h2>
      <button onclick="closeHowItWorks()">✕</button>
    </div>

    <div class="how-content">
      <div class="how-card">
        <span>01</span>
        <h3>Find Charging Stations</h3>
        <p>Discover EV charging stations near you using our interactive map with real-time availability.</p>
      </div>

      <div class="how-card">
        <span>02</span>
        <h3>Compare & Filter</h3>
        <p>Filter stations by type, speed, price in ₹, and distance to find the perfect charging spot.</p>
      </div>

      <div class="how-card">
        <span>03</span>
        <h3>Book Your Slot</h3>
        <p>Reserve a charging slot in advance to guarantee availability and avoid waiting times.</p>
      </div>

      <div class="how-card">
        <span>04</span>
        <h3>Navigate Easily</h3>
        <p>Get turn-by-turn navigation with real-time traffic updates and estimated charging costs.</p>
      </div>

      <div class="how-card">
        <span>05</span>
        <h3>Pay & Charge</h3>
        <p>Transparent pricing in Indian Rupees. Pay via multiple options including UPI, cards, and wallets.</p>
      </div>

      <div class="how-card highlight">
        <span>★</span>
        <h3>Why Choose GRIDFLOW?</h3>
        <p>India's most comprehensive EV charging platform with 20+ stations, real-time booking, and seamless navigation experience.</p>
      </div>
    </div>
  </div>

  <!-- ENERGY BACKGROUND -->
  <div class="energy-bg">
    <span style="left:5%;animation-duration:4s"></span>
    <span style="left:15%;animation-duration:6s"></span>
    <span style="left:25%;animation-duration:5s"></span>
    <span style="left:35%;animation-duration:7s"></span>
    <span style="left:45%;animation-duration:4.5s"></span>
    <span style="left:55%;animation-duration:6.5s"></span>
    <span style="left:65%;animation-duration:5.5s"></span>
    <span style="left:75%;animation-duration:4s"></span>
    <span style="left:85%;animation-duration:6s"></span>
    <span style="left:95%;animation-duration:5s"></span>
  </div>

  <!-- MAP VIEW -->
  <div class="map-view" id="mapView">
    <div class="topbar">
      <div class="user-section" id="userSection">
        <div class="user-avatar" id="userAvatar" onclick="toggleUserMenu()">U</div>
      </div>
      <span id="mapTitle">Charging Stations</span>
      <button onclick="locateUser()">
        <i class="fas fa-location-crosshairs"></i> My Location
      </button>
      <button class="secondary" onclick="goBackToConfig()">
        <i class="fas fa-sliders"></i> Filters
      </button>
      <button class="secondary" onclick="openMyBookings()">
        <i class="fas fa-calendar"></i> My Bookings
      </button>
      <button class="secondary" onclick="goBackToLanding()">
        <i class="fas fa-home"></i> Home
      </button>
    </div>
    <div id="map"></div>
  </div>

  <!-- STATION DETAILS PANEL -->
  <div class="station-details" id="stationDetails">
    <div class="station-header">
      <h3 id="stationName">Station Name</h3>
      <button class="close-details" onclick="closeStationDetails()">✕</button>
    </div>
    
    <div class="station-info">
      <p><i class="fas fa-map-marker-alt"></i> <span id="stationAddress">Address not available</span></p>
      <p><i class="fas fa-plug"></i> <span id="stationType">Type: </span></p>
      <p><i class="fas fa-tachometer-alt"></i> <span id="stationSpeed">Speed: </span></p>
      <p><i class="fas fa-rupee-sign"></i> <span id="stationPrice">Price: </span></p>
      <p><i class="fas fa-clock"></i> <span id="stationHours">24/7</span></p>
    </div>
    
    <div class="availability">
      <h4>Availability <span id="availabilityStatus" class="availability-status available">Available</span></h4>
      <p id="availableSlots">4 out of 6 slots available</p>
      
      <div class="slots-container">
        <div class="slots-header">
          <span>Select Time Slot:</span>
          <span id="selectedTime">Not selected</span>
        </div>
        <div class="slots" id="timeSlots">
          <!-- Time slots will be generated here -->
        </div>
      </div>
      
      <button class="book-btn" id="bookButton" onclick="bookSlot()">
        <i class="fas fa-calendar-check"></i> Book Selected Slot
      </button>
    </div>
    
    <div class="actions-section">
      <h4>Actions</h4>
      <button class="action-btn primary" onclick="startNavigation()">
        <i class="fas fa-route"></i> Navigate to Station
      </button>
      <button class="action-btn secondary" onclick="shareStation()">
        <i class="fas fa-share"></i> Share Station
      </button>
    </div>
  </div>

  <!-- NAVIGATION PANEL -->
  <div class="navigation-panel" id="navigationPanel">
    <div class="nav-header">
      <div class="nav-info">
        <h4 id="navToStation">Navigation Active</h4>
        <p id="navDistance">Calculating distance...</p>
      </div>
      <button class="close-details" onclick="closeNavigation()">✕</button>
    </div>
    
    <div class="nav-stats">
      <div class="stat">
        <div class="stat-value" id="navETA">-- min</div>
        <div class="stat-label">Estimated Time</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="navDistanceVal">-- km</div>
        <div class="stat-label">Distance</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="navBattery">-- %</div>
        <div class="stat-label">Battery After Trip</div>
      </div>
    </div>
    
    <div class="nav-actions">
      <button class="nav-btn primary" onclick="openInMaps()">
        <i class="fas fa-external-link-alt"></i> Open in Maps
      </button>
      <button class="nav-btn secondary" onclick="stopNavigation()">
        <i class="fas fa-stop"></i> Stop Navigation
      </button>
    </div>
  </div>

  <!-- MY BOOKINGS PANEL -->
  <div class="my-bookings" id="myBookings">
    <div class="bookings-header">
      <h2>My Bookings</h2>
      <button onclick="closeMyBookings()">✕</button>
    </div>
    
    <div id="bookingsContainer">
      <!-- Bookings will be dynamically generated here -->
    </div>
    
    <div style="text-align:center;margin-top:2rem;">
      <button class="cta" onclick="goBackToLanding()">
        <i class="fas fa-plus"></i> Book New Station
      </button>
    </div>
  </div>
</div>

<!-- Firebase Configuration -->
<script>
  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyASMVO-kamXNxMKf1QAY6FSLS2q-OngObI",
    authDomain: "ev-station-locator-system.firebaseapp.com",
    projectId: "ev-station-locator-system",
    storageBucket: "ev-station-locator-system.firebasestorage.app",
    messagingSenderId: "708506235224",
    appId: "1:708506235224:web:083410a03d46d3af89f52d"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  // Check auth state on page load - THIS IS CRITICAL
auth.onAuthStateChanged((user) => {
  console.log('Auth state changed:', user ? user.email : 'No user');
  if (user) {
    // User is signed in
    currentUser = user;
    console.log('User logged in, showing main app');
    showMainApp();
  } else {
    // User is signed out
    console.log('No user, showing auth page');
    document.getElementById('authPage').style.display = 'flex';
    document.getElementById('mainApp').style.display = 'none';
  }
});
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

<script>
// Global variables
let map;
let userLocation = null;
let userMarker = null;
let selectedStation = null;
let selectedSlot = null;
let navigationActive = false;
let myBookings = [];
let currentUser = null;

// Extended list of dummy charging stations (20+ stations across Pune)
const stations = [
  // Pune City Center Stations
  {id: 1, name: "Gridflow Hub", lat: 18.5204, lng: 73.8567, type: "CCS", speed: "Ultra Fast", price: "₹18/kWh", address: "FC Road, Pune", available: 4, total: 6, status: "available", operator: "Gridflow"},
  {id: 2, name: "Urban EV Point", lat: 18.5314, lng: 73.8446, type: "Type-2", speed: "Fast", price: "₹15/kWh", address: "JM Road, Pune", available: 1, total: 4, status: "limited", operator: "Urban EV"},
  {id: 3, name: "Express Charge", lat: 18.5074, lng: 73.8077, type: "CHAdeMO", speed: "Ultra Fast", price: "₹20/kWh", address: "Kothrud, Pune", available: 6, total: 8, status: "available", operator: "Express Charge"},
  {id: 4, name: "City Power Station", lat: 18.5523, lng: 73.9021, type: "CCS", speed: "Fast", price: "₹16/kWh", address: "Shivajinagar, Pune", available: 0, total: 4, status: "busy", operator: "City Power"},
  {id: 5, name: "Green Energy Charger", lat: 18.4887, lng: 73.8234, type: "Type-2", speed: "Normal", price: "₹12/kWh", address: "Bavdhan, Pune", available: 3, total: 4, status: "available", operator: "Green Energy"},
  
  // More stations...
  {id: 6, name: "Supercharge Pro", lat: 18.5401, lng: 73.8912, type: "Supercharger", speed: "Ultra Fast", price: "₹22/kWh", address: "Hinjewadi, Pune", available: 5, total: 10, status: "available", operator: "Tesla"},
  {id: 7, name: "Eco Charging Zone", lat: 18.5678, lng: 73.7723, type: "CCS", speed: "Fast", price: "₹15/kWh", address: "Wakad, Pune", available: 2, total: 4, status: "limited", operator: "Eco Charge"},
];

// Time slots for booking
const timeSlots = [
  {time: "08:00 AM", price: "₹180"},
  {time: "09:00 AM", price: "₹190"},
  {time: "10:00 AM", price: "₹200"},
  {time: "11:00 AM", price: "₹210"},
  {time: "12:00 PM", price: "₹220"},
  {time: "01:00 PM", price: "₹210"},
  {time: "02:00 PM", price: "₹200"},
  {time: "03:00 PM", price: "₹190"},
  {time: "04:00 PM", price: "₹200"},
  {time: "05:00 PM", price: "₹220"},
  {time: "06:00 PM", price: "₹240"},
  {time: "07:00 PM", price: "₹230"}
];

// Sample bookings data
myBookings = [
  {
    id: 1,
    stationId: 1,
    stationName: "Gridflow Hub",
    date: "2024-01-15",
    time: "02:00 PM",
    duration: "1 hour",
    cost: "₹200",
    status: "upcoming",
    address: "FC Road, Pune"
  },
  {
    id: 2,
    stationId: 6,
    stationName: "Supercharge Pro",
    date: "2024-01-10",
    time: "11:00 AM",
    duration: "45 mins",
    cost: "₹210",
    status: "completed",
    address: "Hinjewadi, Pune"
  },
  {
    id: 3,
    stationId: 3,
    stationName: "Express Charge",
    date: "2024-01-05",
    time: "04:00 PM",
    duration: "1.5 hours",
    cost: "₹300",
    status: "cancelled",
    address: "Kothrud, Pune"
  }
];

// ================= AUTHENTICATION FUNCTIONS =================

// Switch between login and register tabs
document.getElementById('loginTab').addEventListener('click', function() {
  document.getElementById('loginTab').classList.add('active');
  document.getElementById('registerTab').classList.remove('active');
  document.getElementById('loginForm').style.display = 'flex';
  document.getElementById('registerForm').style.display = 'none';
  document.getElementById('loginError').style.display = 'none';
  document.getElementById('registerError').style.display = 'none';
  document.getElementById('registerSuccess').style.display = 'none';
});

document.getElementById('registerTab').addEventListener('click', function() {
  document.getElementById('registerTab').classList.add('active');
  document.getElementById('loginTab').classList.remove('active');
  document.getElementById('registerForm').style.display = 'flex';
  document.getElementById('loginForm').style.display = 'none';
  document.getElementById('loginError').style.display = 'none';
  document.getElementById('registerError').style.display = 'none';
  document.getElementById('registerSuccess').style.display = 'none';
});

// Check password strength
function checkPasswordStrength(password) {
  const strengthElement = document.getElementById('passwordStrength');
  if (!password) {
    strengthElement.textContent = '';
    strengthElement.className = 'password-strength';
    return;
  }
  
  let strength = 0;
  if (password.length >= 8) strength++;
  if (/[A-Z]/.test(password)) strength++;
  if (/[0-9]/.test(password)) strength++;
  if (/[^A-Za-z0-9]/.test(password)) strength++;
  
  let strengthText = '';
  let strengthClass = '';
  
  if (strength <= 1) {
    strengthText = 'Weak';
    strengthClass = 'weak';
  } else if (strength <= 2) {
    strengthText = 'Medium';
    strengthClass = 'medium';
  } else {
    strengthText = 'Strong';
    strengthClass = 'strong';
  }
  
  strengthElement.textContent = `Password strength: ${strengthText}`;
  strengthElement.className = `password-strength ${strengthClass}`;
}

// Handle login
async function handleLogin(event) {
  event.preventDefault();
  
  const email = document.getElementById('loginEmail').value;
  const password = document.getElementById('loginPassword').value;
  const loginBtn = document.getElementById('loginBtn');
  const errorElement = document.getElementById('loginError');
  
  // Show loading state
  loginBtn.disabled = true;
  loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Signing in...';
  errorElement.style.display = 'none';
  
  try {
    // Sign in with Firebase
    const userCredential = await auth.signInWithEmailAndPassword(email, password);
    currentUser = userCredential.user;
    
    // Show success and redirect
    loginBtn.innerHTML = '<i class="fas fa-check"></i> Success!';
    setTimeout(() => {
      showMainApp();
    }, 1000);
    
  } catch (error) {
    // Handle errors
    let errorMessage = 'An error occurred. Please try again.';
    
    switch (error.code) {
      case 'auth/invalid-email':
        errorMessage = 'Invalid email address.';
        break;
      case 'auth/user-disabled':
        errorMessage = 'This account has been disabled.';
        break;
      case 'auth/user-not-found':
        errorMessage = 'No account found with this email.';
        break;
      case 'auth/wrong-password':
        errorMessage = 'Incorrect password.';
        break;
      case 'auth/network-request-failed':
        errorMessage = 'Network error. Please check your connection.';
        break;
      default:
        errorMessage = error.message || 'An error occurred. Please try again.';
    }
    
    errorElement.style.display = 'flex';
    document.getElementById('loginErrorMessage').textContent = errorMessage;
    
    // Reset button
    loginBtn.disabled = false;
    loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Sign In';
  }
}

// Handle registration
async function handleRegister(event) {
  event.preventDefault();
  
  const name = document.getElementById('registerName').value;
  const email = document.getElementById('registerEmail').value;
  const password = document.getElementById('registerPassword').value;
  const confirmPassword = document.getElementById('registerConfirmPassword').value;
  const registerBtn = document.getElementById('registerBtn');
  const errorElement = document.getElementById('registerError');
  const successElement = document.getElementById('registerSuccess');
  
  // Validate passwords match
  if (password !== confirmPassword) {
    errorElement.style.display = 'flex';
    document.getElementById('registerErrorMessage').textContent = 'Passwords do not match.';
    return;
  }
  
  // Show loading state
  registerBtn.disabled = true;
  registerBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating account...';
  errorElement.style.display = 'none';
  successElement.style.display = 'none';
  
  try {
    // Create user with Firebase
    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
    currentUser = userCredential.user;
    
    // Update user profile
    await currentUser.updateProfile({
      displayName: name
    });
    
    // Save additional user data to Firestore
    await db.collection('users').doc(currentUser.uid).set({
      name: name,
      email: email,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    // Show success message
    successElement.style.display = 'flex';
    registerBtn.innerHTML = '<i class="fas fa-check"></i> Account Created!';
    
    // Redirect to main app after delay
    setTimeout(() => {
      showMainApp();
    }, 1500);
    
  } catch (error) {
    // Handle errors
    let errorMessage = 'An error occurred. Please try again.';
    
    switch (error.code) {
      case 'auth/email-already-in-use':
        errorMessage = 'Email already in use.';
        break;
      case 'auth/invalid-email':
        errorMessage = 'Invalid email address.';
        break;
      case 'auth/weak-password':
        errorMessage = 'Password should be at least 6 characters.';
        break;
      case 'auth/network-request-failed':
        errorMessage = 'Network error. Please check your connection.';
        break;
      default:
        errorMessage = error.message || 'An error occurred. Please try again.';
    }
    
    errorElement.style.display = 'flex';
    document.getElementById('registerErrorMessage').textContent = errorMessage;
    
    // Reset button
    registerBtn.disabled = false;
    registerBtn.innerHTML = '<i class="fas fa-user-plus"></i> Create Account';
  }
}

// Show main application after login
function showMainApp() {
  document.getElementById('authPage').style.display = 'none';
  document.getElementById('mainApp').style.display = 'block';
  updateUserUI();
  initApp();
}

// Update user UI in main app
function updateUserUI() {
  if (currentUser) {
    const userAvatar = document.getElementById('userAvatar');
    const userEmail = document.getElementById('userEmail');
    const userName = document.getElementById('userName');
    
    // Get first letter of email or name for avatar
    const displayName = currentUser.displayName || currentUser.email;
    const firstLetter = displayName ? displayName.charAt(0).toUpperCase() : 'U';
    userAvatar.textContent = firstLetter;
    
    userEmail.textContent = currentUser.email;
    userName.textContent = currentUser.displayName || 'User';
  }
}

// Logout function
async function logout() {
  try {
    await auth.signOut();
    // Hide main app and show auth page
    document.getElementById('mainApp').style.display = 'none';
    document.getElementById('authPage').style.display = 'flex';
    document.getElementById('userMenu').classList.remove('active');
    
    // Reset forms
    document.getElementById('loginEmail').value = '';
    document.getElementById('loginPassword').value = '';
    document.getElementById('registerName').value = '';
    document.getElementById('registerEmail').value = '';
    document.getElementById('registerPassword').value = '';
    document.getElementById('registerConfirmPassword').value = '';
    
    // Reset to login tab
    document.getElementById('loginTab').classList.add('active');
    document.getElementById('registerTab').classList.remove('active');
    document.getElementById('loginForm').style.display = 'flex';
    document.getElementById('registerForm').style.display = 'none';
    
    currentUser = null;
  } catch (error) {
    console.error('Logout error:', error);
    alert('Error logging out: ' + error.message);
  }
}

// Toggle user menu
function toggleUserMenu() {
  const userMenu = document.getElementById('userMenu');
  userMenu.classList.toggle('active');
}

// Close user menu when clicking outside
document.addEventListener('click', (event) => {
  const userMenu = document.getElementById('userMenu');
  const userAvatar = document.getElementById('userAvatar');
  
  if (userMenu && userAvatar && !userMenu.contains(event.target) && !userAvatar.contains(event.target)) {
    userMenu.classList.remove('active');
  }
});

// Check auth state on page load
auth.onAuthStateChanged((user) => {
  if (user) {
    // User is signed in
    currentUser = user;
    showMainApp();
  }
  // If user is not signed in, auth page will remain visible
});

// ================= MAIN APP FUNCTIONS =================

// Initialize the application
function initApp() {
  // Set up event listeners
  document.getElementById('bookButton').disabled = true;
  
  // Try to get user location on startup
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      (position) => {
        userLocation = {
          lat: position.coords.latitude,
          lng: position.coords.longitude
        };
      },
      (error) => {
        console.log("Geolocation error:", error);
        // Default to Pune if location not available
        userLocation = { lat: 18.5204, lng: 73.8567 };
      }
    );
  } else {
    userLocation = { lat: 18.5204, lng: 73.8567 };
  }
  
  // Load bookings
  renderBookings();
}

// Open configuration panel
function openConfig() {
  document.getElementById('landing').style.display = "none";
  document.getElementById('config').style.display = "block";
}

// Go back to landing page
function goBackToLanding() {
  document.getElementById('landing').style.display = "flex";
  document.getElementById('config').style.display = "none";
  document.getElementById('mapView').style.display = "none";
  document.getElementById('stationDetails').classList.remove('active');
  document.getElementById('navigationPanel').classList.remove('active');
  document.getElementById('myBookings').classList.remove('active');
  document.getElementById('howItWorks').classList.add('hidden');
}

// Go back to config from map
function goBackToConfig() {
  document.getElementById('config').style.display = "block";
  document.getElementById('mapView').style.display = "none";
}

// Open the map with stations
function openMap() {
  document.getElementById('config').style.display = "none";
  document.getElementById('mapView').style.display = "block";
  
  // Initialize map if not already done
  if (!map) {
    map = L.map('map').setView([18.5204, 73.8567], 12);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: '© GRIDFLOW'
    }).addTo(map);
  } else {
    map.setView([18.5204, 73.8567], 12);
  }
  
  // Clear existing markers
  map.eachLayer((layer) => {
    if (layer instanceof L.Marker || layer instanceof L.CircleMarker) {
      map.removeLayer(layer);
    }
  });
  
  // Add user location if available
  if (userLocation) {
    if (userMarker) {
      map.removeLayer(userMarker);
    }
    userMarker = L.marker([userLocation.lat, userLocation.lng], {
      icon: L.divIcon({
        className: 'user-location-marker',
        iconSize: [20, 20]
      })
    }).addTo(map)
      .bindPopup('<b>Your Location</b>')
      .openPopup();
    
    // Center map on user location
    map.setView([userLocation.lat, userLocation.lng], 13);
  }
  
  // Add station markers
  stations.forEach(station => {
    // Determine marker color based on availability
    let markerColor = '#facc15'; // Default yellow
    if (station.status === 'limited') markerColor = '#f59e0b';
    if (station.status === 'busy') markerColor = '#ef4444';
    if (station.status === 'available') markerColor = '#10b981';
    
    // Create custom icon
    const marker = L.circleMarker([station.lat, station.lng], {
      radius: 10,
      color: markerColor,
      fillColor: markerColor,
      fillOpacity: 1,
      weight: 2
    }).addTo(map);
    
    // Add click event to show station details
    marker.on('click', () => {
      showStationDetails(station);
    });
    
    // Bind popup with station info
    const popupContent = `
      <div style="font-weight:600;margin-bottom:5px;color:${markerColor}">${station.name}</div>
      <div style="margin-bottom:3px"><i class="fas fa-plug"></i> ${station.type} • ${station.speed}</div>
      <div style="margin-bottom:3px"><i class="fas fa-rupee-sign"></i> ${station.price}</div>
      <div style="margin-bottom:8px">${station.available}/${station.total} slots available</div>
      <button onclick="event.stopPropagation(); showStationDetails(${station.id})" 
        style="background:#facc15;color:black;border:none;padding:6px 12px;border-radius:5px;margin-top:5px;cursor:pointer;width:100%;font-weight:600">
        <i class="fas fa-info-circle"></i> View Details
      </button>
    `;
    
    marker.bindPopup(popupContent);
  });
  
  // Update map title
  document.getElementById('mapTitle').textContent = `Found ${stations.length} Charging Stations`;
}

// Show station details panel
function showStationDetails(stationId) {
  // If stationId is an object (from direct call), use it
  // If it's a number (from popup button), find the station
  let station;
  if (typeof stationId === 'object') {
    station = stationId;
  } else {
    station = stations.find(s => s.id === stationId);
  }
  
  if (!station) return;
  
  selectedStation = station;
  selectedSlot = null;
  
  // Update station details
  document.getElementById('stationName').textContent = station.name;
  document.getElementById('stationAddress').textContent = station.address;
  document.getElementById('stationType').textContent = `Type: ${station.type}`;
  document.getElementById('stationSpeed').textContent = `Speed: ${station.speed}`;
  document.getElementById('stationPrice').textContent = `Price: ${station.price}`;
  document.getElementById('stationHours').textContent = "Open 24/7";
  
  // Update availability
  const statusElement = document.getElementById('availabilityStatus');
  const statusText = station.status === 'available' ? 'Available' : 
                     station.status === 'limited' ? 'Limited' : 'Busy';
  statusElement.textContent = statusText;
  statusElement.className = `availability-status ${station.status}`;
  
  document.getElementById('availableSlots').textContent = 
    `${station.available} out of ${station.total} slots available`;
  
  // Reset selected time
  document.getElementById('selectedTime').textContent = "Not selected";
  
  // Generate time slots
  const slotsContainer = document.getElementById('timeSlots');
  slotsContainer.innerHTML = '';
  
  timeSlots.forEach((slot, index) => {
    const slotElement = document.createElement('div');
    slotElement.className = 'slot';
    
    // Randomly mark some slots as booked for demo
    const isBooked = Math.random() > 0.7 && index > 2 && index < 10;
    
    if (isBooked) {
      slotElement.classList.add('booked');
    }
    
    slotElement.innerHTML = `
      <div class="slot-time">${slot.time}</div>
      <div class="slot-price">${slot.price}</div>
    `;
    
    // Add click event
    if (!isBooked) {
      slotElement.addEventListener('click', () => {
        // Deselect all slots
        document.querySelectorAll('.slot').forEach(s => {
          s.classList.remove('selected');
        });
        
        // Select this slot
        slotElement.classList.add('selected');
        selectedSlot = slot;
        document.getElementById('bookButton').disabled = false;
        document.getElementById('selectedTime').textContent = `${slot.time} (${slot.price})`;
      });
    }
    
    slotsContainer.appendChild(slotElement);
  });
  
  // Show the details panel
  document.getElementById('stationDetails').classList.add('active');
  document.getElementById('bookButton').disabled = true;
  
  // Pan map to the station
  map.setView([station.lat, station.lng], 15);
}

// Close station details panel
function closeStationDetails() {
  document.getElementById('stationDetails').classList.remove('active');
  selectedStation = null;
  selectedSlot = null;
  document.getElementById('bookButton').disabled = true;
}

// Book a time slot
function bookSlot() {
  if (!selectedStation || !selectedSlot) return;
  
  // Check if user is logged in
  if (!currentUser) {
    alert('Please login to book a slot.');
    return;
  }
  
  // Generate booking ID
  const bookingId = Date.now();
  
  // Create new booking
  const newBooking = {
    id: bookingId,
    stationId: selectedStation.id,
    stationName: selectedStation.name,
    date: new Date().toISOString().split('T')[0],
    time: selectedSlot.time,
    duration: "1 hour",
    cost: selectedSlot.price,
    status: "upcoming",
    address: selectedStation.address,
    userId: currentUser.uid
  };
  
  // Add to bookings
  myBookings.unshift(newBooking);
  
  // Update station availability
  selectedStation.available--;
  if (selectedStation.available < 1) {
    selectedStation.status = 'busy';
  } else if (selectedStation.available < 3) {
    selectedStation.status = 'limited';
  }
  
  // Save to Firestore
  db.collection('bookings').add({
    ...newBooking,
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    userId: currentUser.uid
  }).catch(error => {
    console.error('Error saving booking to Firestore:', error);
  });
  
  // Update UI
  renderBookings();
  
  // Show confirmation
  const modalContent = `
    <div style="text-align:center;padding:2rem">
      <div style="font-size:3rem;color:#10b981;margin-bottom:1rem">✓</div>
      <h3 style="color:var(--yellow);margin-bottom:1rem">Booking Confirmed!</h3>
      <p style="margin-bottom:0.5rem"><strong>Station:</strong> ${selectedStation.name}</p>
      <p style="margin-bottom:0.5rem"><strong>Time:</strong> ${selectedSlot.time}</p>
      <p style="margin-bottom:0.5rem"><strong>Cost:</strong> ${selectedSlot.price}</p>
      <p style="margin-bottom:1.5rem"><strong>Booking ID:</strong> GRID${bookingId.toString().slice(-6)}</p>
      <button onclick="this.parentElement.parentElement.style.display='none'; closeStationDetails();" 
        style="background:var(--yellow);color:black;border:none;padding:0.8rem 2rem;border-radius:999px;font-weight:600;cursor:pointer">
        Done
      </button>
    </div>
  `;
  
  // Create and show modal
  const modal = document.createElement('div');
  modal.style.position = 'fixed';
  modal.style.top = '0';
  modal.style.left = '0';
  modal.style.width = '100%';
  modal.style.height = '100%';
  modal.style.backgroundColor = 'rgba(0,0,0,0.9)';
  modal.style.zIndex = '9999';
  modal.style.display = 'flex';
  modal.style.alignItems = 'center';
  modal.style.justifyContent = 'center';
  modal.innerHTML = modalContent;
  document.body.appendChild(modal);
  
  // Close modal and details after 5 seconds
  setTimeout(() => {
    if (modal.parentElement) {
      modal.parentElement.removeChild(modal);
    }
    closeStationDetails();
  }, 5000);
}

// Render bookings in My Bookings panel
function renderBookings() {
  const container = document.getElementById('bookingsContainer');
  
  if (myBookings.length === 0) {
    container.innerHTML = `
      <div class="no-bookings">
        <i class="fas fa-calendar-times"></i>
        <h3>No Bookings Yet</h3>
        <p>You haven't made any bookings yet. Find and book a charging station to get started!</p>
      </div>
    `;
    return;
  }
  
  let html = '<div class="bookings-list">';
  
  myBookings.forEach(booking => {
    const statusClass = `status-${booking.status}`;
    const cardClass = `booking-card ${booking.status}`;
    
    html += `
      <div class="${cardClass}">
        <div class="booking-header">
          <div class="booking-station">${booking.stationName}</div>
          <div class="booking-status ${statusClass}">
            ${booking.status.charAt(0).toUpperCase() + booking.status.slice(1)}
          </div>
        </div>
        <div class="booking-details">
          <p><i class="fas fa-calendar"></i> ${booking.date} at ${booking.time}</p>
          <p><i class="fas fa-clock"></i> Duration: ${booking.duration}</p>
          <p><i class="fas fa-rupee-sign"></i> Cost: ${booking.cost}</p>
          <p><i class="fas fa-map-marker-alt"></i> ${booking.address}</p>
        </div>
        <div class="booking-actions">
          ${booking.status === 'upcoming' ? `
            <button class="booking-btn cancel" onclick="cancelBooking(${booking.id})">
              <i class="fas fa-times"></i> Cancel
            </button>
            <button class="booking-btn navigate" onclick="navigateToBooking(${booking.stationId})">
              <i class="fas fa-route"></i> Navigate
            </button>
          ` : ''}
          ${booking.status === 'completed' ? `
            <button class="booking-btn" style="background:rgba(16,185,129,0.1);color:var(--green);border:1px solid var(--green);width:100%" onclick="rebookStation(${booking.stationId})">
              <i class="fas fa-redo"></i> Rebook
            </button>
          ` : ''}
        </div>
      </div>
    `;
  });
  
  html += '</div>';
  container.innerHTML = html;
}

// Cancel a booking
function cancelBooking(bookingId) {
  if (confirm("Are you sure you want to cancel this booking?")) {
    const booking = myBookings.find(b => b.id === bookingId);
    if (booking) {
      booking.status = 'cancelled';
      
      // Find the station and increase availability
      const station = stations.find(s => s.id === booking.stationId);
      if (station) {
        station.available++;
        if (station.status === 'busy' && station.available > 0) {
          station.status = station.available < 3 ? 'limited' : 'available';
        }
      }
      
      renderBookings();
      alert("Booking cancelled successfully!");
    }
  }
}

// Navigate to a booked station
function navigateToBooking(stationId) {
  const station = stations.find(s => s.id === stationId);
  if (station) {
    closeMyBookings();
    openMap();
    setTimeout(() => {
      showStationDetails(station);
      startNavigation();
    }, 500);
  }
}

// Rebook a previously used station
function rebookStation(stationId) {
  const station = stations.find(s => s.id === stationId);
  if (station) {
    closeMyBookings();
    openMap();
    setTimeout(() => {
      showStationDetails(station);
    }, 500);
  }
}

// Open My Bookings panel
function openMyBookings() {
  document.getElementById('myBookings').classList.add('active');
  document.getElementById('landing').style.display = "none";
}

// Close My Bookings panel
function closeMyBookings() {
  document.getElementById('myBookings').classList.remove('active');
  document.getElementById('landing').style.display = "flex";
}

// Start navigation to selected station
function startNavigation() {
  if (!selectedStation) return;
  
  // Calculate distance and ETA (simulated)
  let distance = 0;
  let eta = 0;
  let batteryAfter = 0;
  
  if (userLocation) {
    distance = calculateDistance(
      userLocation.lat, userLocation.lng,
      selectedStation.lat, selectedStation.lng
    );
    eta = Math.round(distance * 3); // Simulated ETA calculation (3 min per km)
    batteryAfter = Math.max(15, Math.round(85 - distance * 5)); // Simulated battery calculation
  } else {
    distance = 5.2; // Default distance
    eta = 16; // Default ETA
    batteryAfter = 60; // Default battery
  }
  
  // Update navigation panel
  document.getElementById('navToStation').textContent = `To: ${selectedStation.name}`;
  document.getElementById('navDistance').textContent = `${distance.toFixed(1)} km • ${eta} min ETA`;
  document.getElementById('navDistanceVal').textContent = `${distance.toFixed(1)} km`;
  document.getElementById('navETA').textContent = `${eta} min`;
  document.getElementById('navBattery').textContent = `${batteryAfter}%`;
  
  // Show navigation panel
  document.getElementById('navigationPanel').classList.add('active');
  navigationActive = true;
  
  // Draw route on map (simulated with a polyline)
  if (userLocation) {
    // Remove existing route if any
    map.eachLayer((layer) => {
      if (layer instanceof L.Polyline) {
        map.removeLayer(layer);
      }
    });
    
    const routeCoordinates = [
      [userLocation.lat, userLocation.lng],
      [selectedStation.lat, selectedStation.lng]
    ];
    
    L.polyline(routeCoordinates, {
      color: '#3b82f6',
      weight: 5,
      opacity: 0.8,
      dashArray: '10, 10'
    }).addTo(map);
  }
}

// Close navigation panel
function closeNavigation() {
  document.getElementById('navigationPanel').classList.remove('active');
  navigationActive = false;
  
  // Remove route from map
  map.eachLayer((layer) => {
    if (layer instanceof L.Polyline) {
      map.removeLayer(layer);
    }
  });
}

// Stop navigation
function stopNavigation() {
  closeNavigation();
  alert('Navigation stopped.');
}

// Open in external maps app
function openInMaps() {
  if (!selectedStation) return;
  
  const url = `https://www.google.com/maps/dir/?api=1&destination=${selectedStation.lat},${selectedStation.lng}`;
  window.open(url, '_blank');
}

// Locate user on map
function locateUser() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      (position) => {
        userLocation = {
          lat: position.coords.latitude,
          lng: position.coords.longitude
        };
        
        // Update or add user marker
        if (userMarker) {
          map.removeLayer(userMarker);
        }
        
        userMarker = L.marker([userLocation.lat, userLocation.lng], {
          icon: L.divIcon({
            className: 'user-location-marker',
            iconSize: [20, 20]
          })
        }).addTo(map)
          .bindPopup('<b>Your Location</b>')
          .openPopup();
        
        // Center map on user
        map.setView([userLocation.lat, userLocation.lng], 14);
        
        alert('Location updated!');
      },
      (error) => {
        alert('Unable to get your location. Please enable location services.');
      }
    );
  } else {
    alert('Geolocation is not supported by your browser.');
  }
}

// Share station
function shareStation() {
  if (!selectedStation) return;
  
  const shareText = `Check out ${selectedStation.name} EV charging station on GRIDFLOW! ${selectedStation.address} - ${selectedStation.price}`;
  
  if (navigator.share) {
    navigator.share({
      title: 'GRIDFLOW Charging Station',
      text: shareText,
      url: window.location.href
    });
  } else {
    // Fallback to clipboard
    navigator.clipboard.writeText(shareText);
    alert('Station details copied to clipboard!');
  }
}

// Calculate distance between two coordinates (simplified)
function calculateDistance(lat1, lon1, lat2, lon2) {
  const R = 6371; // Earth radius in km
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = 
    Math.sin(dLat/2) * Math.sin(dLat/2) +
    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
    Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

// How it works functions
function openHowItWorks() {
  document.getElementById('howItWorks').classList.remove('hidden');
}

function closeHowItWorks() {
  document.getElementById('howItWorks').classList.add('hidden');
}
</script>
</body>
</html>
